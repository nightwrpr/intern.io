const express = require('express');
const router = express.Router();
const db = require('../db'); // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• MySQL
const { v4: uuidv4 } = require('uuid');
const multer = require('multer');
const path = require('path');
const fs = require('fs');

// üìÇ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const uploadPath = path.join(__dirname, 'uploads', 'uploads');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
    fs.existsSync(uploadPath) || fs.mkdirSync(uploadPath, { recursive: true });

    cb(null, uploadPath); // üìÇ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå
  },
  filename: (req, file, cb) => {
    cb(null, Date.now() + path.extname(file.originalname)); // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
  }
});

const upload = multer({
  storage: storage,
  limits: { fileSize: 5 * 1024 * 1024 }, // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå 5MB
  fileFilter: (req, file, cb) => {
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'), false);
    }
  }
}).fields([
  { name: 'documents[resume]', maxCount: 1 },
  { name: 'documents[transcript]', maxCount: 1 },
  { name: 'documents[id_card]', maxCount: 1 },
  { name: 'documents[consent]', maxCount: 1 },
  { name: 'documents[parent_id]', maxCount: 1 },
  { name: 'documents[student_card]', maxCount: 1 },
  { name: 'documents[bank_book]', maxCount: 1 },
  { name: 'documents[passport]', maxCount: 1 }
]);
// Middleware ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
function checkRole(req, res, next) {
  if (!req.session.user) {
    return res.redirect('/users/login'); // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ login
  }

  const userRole = req.session.user.role?.toLowerCase();
  if (!['admin', 'student'].includes(userRole)) {
    return res.status(403).send('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
  }

  next();
}

// Function ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
async function fetchStudentData(studentId) {
  try {
    const [results] = await db.promise().query(
      `SELECT student_code, major, graduation_status, internship_status 
       FROM student WHERE student_id = ? LIMIT 1`,
      [studentId]
    );
    return results.length > 0 ? results[0] : null;
  } catch (err) {
    console.error('‚ùå Error fetching student data:', err);
    throw err;
  }
}

// üìå Route: ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô (admin/student)
router.get('/', checkRole, async (req, res) => {
  const user = req.session.user;
  const userId = user.id;

  if (!userId) {
    return res.status(400).send('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô session');
  }

  try {
    const [userResults] = await db.promise().query(
      'SELECT name, email, student_id FROM user WHERE user_id = ? LIMIT 1',
      [userId]
    );

    if (userResults.length === 0) {
      return res.status(404).send('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
    }

    const userData = userResults[0];
    const student = await fetchStudentData(userData.student_id);
    if (!student) {
      return res.status(404).send('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
    }

    const [company] = await db.promise().query('SELECT company_id, name FROM company');
    const [position_open] = await db.promise().query('SELECT position_name, position_id FROM position_open');

    res.render('reqforintern', {
      user: userData,
      student,
      company,
      position_open,
      errorMessage: req.session.errorMessage || null,
      successMessage: req.session.successMessage || null
    });

    req.session.errorMessage = null;
    req.session.successMessage = null;
  } catch (err) {
    console.error('‚ùå Error:', err);
    res.status(500).send('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
  }
});

// üìå Route: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
router.post('/submit', checkRole, upload, async (req, res) => {
  console.log('üì® Received data:', req.body);
  console.log('üìÅ Uploaded files:', req.files);

  const { position_id, company_id, request_start_date, request_end_date, semester, course_opening_id } = req.body;
  const documents = req.files; // get uploaded files from req.files

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (!position_id || !company_id || !request_start_date || !request_end_date || !semester || !course_opening_id) {
    req.session.errorMessage = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
    return res.redirect('/reqforintern');
  }

  const user_id = req.session.user.id;

  try {
    const [results] = await db.promise().query('SELECT student_id FROM user WHERE user_id = ?', [user_id]);

    if (results.length === 0) {
      req.session.errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
      return res.redirect('/reqforintern');
    }

    const student_id = results[0].student_id;
    if (!student_id) {
      req.session.errorMessage = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• student_id';
      return res.redirect('/reqforintern');
    }

    const request_id = uuidv4();
    const status = 'P'; // Pending

    const sqlInsertRequest = `
      INSERT INTO internship_request 
      (request_id, company_id, position_id, request_start_date, request_end_date, student_id, semester, status, course_opening_id, create_up)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
    `;
    await db.promise().query(sqlInsertRequest, [
      request_id, company_id, position_id, request_start_date, request_end_date, user_id, semester, status, course_opening_id
    ]);

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
    if (documents) {
      for (let [key, files] of Object.entries(documents)) {
        files.forEach(async (file) => {
          const document_id = uuidv4();
          const sqlInsertDocument = `
            INSERT INTO document (document_id, document_type, file_path, request_id, create_up)
            VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
          `;
          await db.promise().query(sqlInsertDocument, [document_id, key, file.path, request_id]);  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á request_id ‡∏Å‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        });
      }
    }

    console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢:', request_id);
    req.session.successMessage = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
    return res.redirect('/');
  } catch (err) {
    console.error('‚ùå Error:', err);
    req.session.errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    return res.redirect('/reqforintern');
  }
});
module.exports = router;
